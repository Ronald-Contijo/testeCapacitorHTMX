<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

  <title>Notas üê¥</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <!-- anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" defer></script>

  <!-- Shim: evita erros se app.* for chamado antes do app.js -->
  <script>
    window.app = window.app || {
      showList(){}, showForm(){}, showSettings(){},
      saveNote(){}, deleteNote(){}, deleteCurrentNote(){},
      importJSON(){}, exportJSON(){}
    };
  </script>

  <style>
    body { padding-bottom: 4.5rem; }
    :root {
      --color-surface:        #ffffff;
      --color-surface-muted:  #f1f5f9;
      --color-text:           #0f172a; /* sempre preto */
      --color-border:         #e2e8f0;
      --color-primary:        #0f766e;
      --color-primary-fg:     #ffffff;
      --color-danger:         #dc2626;
      --color-danger-fg:      #ffffff;
    }
    /* overlay do flash radial */
    #theme-flash {
      pointer-events: none;
      position: fixed; inset: 0;
      opacity: 0;
      background: radial-gradient(circle at var(--x,50%) var(--y,50%),
                  rgba(255,255,255,0.55), transparent 60%);
      mix-blend-mode: screen;
      z-index: 50;
    }
  </style>

  <script>
    const THEME_KEY = 'app_theme_vars_v4';

    const hsl = (h,s,l)=>`hsl(${Math.round(h)},${Math.round(s)}%,${Math.round(l)}%)`;
    const rand = (a,b)=>a+Math.random()*(b-a);
    const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];

    function applyThemeVars(vars){
      const root=document.documentElement;
      Object.entries(vars).forEach(([k,v])=>root.style.setProperty(`--${k}`,v));
    }
    function saveTheme(vars){ localStorage.setItem(THEME_KEY,JSON.stringify(vars)); }
    function loadTheme(){
      try{ return JSON.parse(localStorage.getItem(THEME_KEY)); }catch{ return null; }
    }

    // Tema v√≠vido e aleat√≥rio; fundos tamb√©m mudam; texto sempre preto
    function generateTheme(){
      const H = rand(0,360);
      const mode = pick(['complement','triad','analog']);
      const H_accent =
        mode==='complement' ? (H+180)%360 :
        mode==='triad'      ? (H+120)%360 :
                              (H+rand(20,40))%360;
      const H_danger = (H+pick([340,350,0,10,20]))%360;

      const sBase = rand(22,38);
      const surface        = hsl(H_accent, sBase, rand(90,96));
      const surfaceMuted   = hsl(H_accent, sBase+rand(4,12), rand(80,88));
      const border         = hsl(H_accent, sBase+rand(8,16), rand(68,78));
      const primary        = hsl(H, rand(70,92), rand(45,60));
      const danger         = hsl(H_danger, rand(70,92), rand(46,58));

      return {
        'color-surface':        surface,
        'color-surface-muted':  surfaceMuted,
        'color-border':         border,
        'color-text':           '#0f172a', // sempre preto
        'color-primary':        primary,
        'color-primary-fg':     '#ffffff',
        'color-danger':         danger,
        'color-danger-fg':      '#ffffff',
      };
    }

    // Interpola√ß√£o animada das vari√°veis com anime.js (se dispon√≠vel)
    function animateTheme(toVars, ev){
      const root = document.documentElement;
      const cur = (name)=>getComputedStyle(root).getPropertyValue(`--${name}`).trim();
      const keys = ['color-surface','color-surface-muted','color-border','color-primary','color-danger'];

      // flash radial opcional
      const flash = document.getElementById('theme-flash');
      if (flash && window.anime){
        const cx = (ev?.clientX ?? innerWidth/2) / innerWidth * 100 + '%';
        const cy = (ev?.clientY ?? innerHeight*0.3) / innerHeight * 100 + '%';
        flash.style.setProperty('--x', cx);
        flash.style.setProperty('--y', cy);
        anime({ targets: flash, opacity: [0,0.9,0], duration: 700, easing: 'easeOutQuad' });
      }

      if (!window.anime){
        applyThemeVars(toVars);
        return;
      }

      // parse hsl(...) -> {h,s,l}
      const toHSL = (v)=>{
        const m=v.match(/hsl\(([\d.]+),\s*([\d.]+)%?,\s*([\d.]+)%\)/i);
        if (m) return {h:+m[1], s:+m[2], l:+m[3]};
        return {h:0,s:0,l:100};
      };

      const from = {}, to = {};
      keys.forEach(k=>{
        from[k] = toHSL(cur(k));
        to[k]   = toHSL(toVars[k]);
      });

      anime({
        targets: {t:0},
        t: 1,
        duration: 900,
        easing: 'easeInOutCubic',
        update: anim=>{
          const p = anim.animations[0].currentValue;
          keys.forEach(k=>{
            const h = from[k].h + (to[k].h - from[k].h)*p;
            const s = from[k].s + (to[k].s - from[k].s)*p;
            const l = from[k].l + (to[k].l - from[k].l)*p;
            root.style.setProperty(`--${k}`, hsl(h,s,l));
          });
          root.style.setProperty('--color-text','#0f172a');
          root.style.setProperty('--color-primary-fg','#ffffff');
          root.style.setProperty('--color-danger-fg','#ffffff');
        }
      });

      // micro anima√ß√µes
      anime({
        targets: ['header','nav'],
        boxShadow: ['0 0 0 rgba(0,0,0,0)','0 10px 30px rgba(0,0,0,0.08)','0 0 0 rgba(0,0,0,0)'],
        duration: 900, easing: 'easeInOutQuad'
      });
      anime({
        targets: 'button, a, .card, .item',
        translateY: [6,0],
        opacity: [0.6,1],
        delay: anime.stagger(18),
        duration: 520,
        easing: 'easeOutCubic'
      });
    }

    // aplica o salvo cedo
    (function(){
      const saved = loadTheme();
      if (saved) applyThemeVars(saved);
    })();

    window.Theme = {
      randomize(ev){
        const vars = generateTheme();
        saveTheme(vars);
        animateTheme(vars, ev);
      },
      reset(){
        localStorage.removeItem(THEME_KEY);
        const defaults = {
          'color-surface':'#ffffff',
          'color-surface-muted':'#f1f5f9',
          'color-border':'#e2e8f0',
          'color-text':'#0f172a',
          'color-primary':'#0f766e',
          'color-primary-fg':'#ffffff',
          'color-danger':'#dc2626',
          'color-danger-fg':'#ffffff',
        };
        saveTheme(defaults);
        animateTheme(defaults);
      }
    };
  </script>
</head>

<body class="bg-[var(--color-surface)] text-[var(--color-text)] min-h-dvh">
  <div id="theme-flash"></div>

  <header class="bg-[var(--color-surface)] border-b border-[var(--color-border)] p-4">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-semibold flex items-center gap-2">
        üê¥ Notas HTMX 
      </h1>

      <!-- A√ß√µes de tema -->
      <div class="flex items-center gap-2">
        <button id="btn-theme-random"
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-[var(--color-border)] bg-[var(--color-surface)] hover:bg-[var(--color-surface-muted)] active:scale-95 transition"
          onclick="Theme.randomize(event)" title="Gerar tema aleat√≥rio e salvar">
          üé®
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 7h-9M14 17H4M20 12H4" />
          </svg>
          <span class="hidden sm:inline">Tema aleat√≥rio</span>
        </button>

        <button id="btn-theme-reset"
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-[var(--color-border)] bg-[var(--color-surface)] hover:bg-[var(--color-surface-muted)] transition"
          onclick="Theme.reset()" title="Voltar ao tema padr√£o">
          ‚ôªÔ∏è
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4"
               viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 12a8 8 0 1 1-8-8" />
            <path d="M4 4v6h6" />
          </svg>
          <span class="hidden sm:inline">Resetar</span>
        </button>
      </div>
    </div>
  </header>

  <main id="main" class="max-w-2xl mx-auto px-4 py-4"
        hx-get="partials/notes_list.html"
        hx-trigger="load"
        hx-target="#main"
        hx-swap="innerHTML">
    <!-- htmx carrega a lista aqui -->
  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-[var(--color-surface)] border-t border-[var(--color-border)] pb-4">
    <div class="max-w-2xl mx-auto grid grid-cols-3">
      <button class="py-3 text-sm font-medium hover:bg-[var(--color-surface-muted)]"
              onclick="app.showList()">üìÑ Notas</button>
      <button class="py-3 text-sm font-medium hover:bg-[var(--color-surface-muted)]"
              onclick="app.showForm()">‚ûï Nova</button>
      <button class="py-3 text-sm font-medium hover:bg-[var(--color-surface-muted)]"
              onclick="app.showSettings()">‚öôÔ∏è Config</button>
    </div>
  </nav>

  <!-- Aplica novamente o tema salvo ao final e anima entrada se anime.js existir -->
  <script>
    const savedAtEnd = loadTheme?.();
    if (savedAtEnd) applyThemeVars(savedAtEnd);

    if (window.anime){
      anime({ targets: 'header, nav', translateY: [-12,0], opacity: [0,1], duration: 600, easing: 'easeOutCubic' });
      anime({ targets: '#main', opacity: [0,1], scale: [0.98,1], duration: 700, delay: 120, easing: 'easeOutCubic' });
    }
  </script>

  <!-- seus m√≥dulos (mantidos) -->
  <script type="module" src="js/db.js"></script>
  <script type="module" src="js/app.js"></script>
</body>
</html>
